@page "/posts/{id:int}"
@using ApiContracts.Dtos.PostDtos
@using ApiContracts.Dtos.CommentDtos
@using ApiContracts.Dtos
@using BlazorApp.Services
@using BlazorApp.Services.Comment
@inject IPostService PostService
@inject IUserService UserService
@inject ICommentService CommentService

<h3>Post Details</h3>

@if (post == null)
{
    <p>Loading...</p>
}
else
{
    <h4>@post.Title</h4>
    <p>@post.Body</p>
    <p><b>Author:</b> @GetAuthorName(post.UserId)</p>
    
    <hr />

    <h5>Comments</h5>

    @if (comments == null)
    {
        <p>Loading comments...</p>
    }
    else if (comments.Count == 0)
    {
        <p>No comments yet.</p>
    }
    else
    {
        <ul>
            @foreach (var comment in comments)
            {
                <li>@GetAuthorName(comment.UserId): @comment.Body</li>
            }
        </ul>
    }
    
    <hr />
    <h5>Add a Comment</h5>

    <!-- Text area for comment text -->
    <textarea @bind="newComment.Body" placeholder="Write your comment..." rows="3" style="width: 300px;"></textarea>
    <br />

    <!-- Input for user ID -->
    <input type="number" @bind="newComment.UserId" placeholder="Your User ID" min="1" />
    <br />

    <!-- Add comment button -->
    <button @onclick="AddCommentAsync">Add Comment</button>

    @if (!string.IsNullOrEmpty(message))
    {
        <p>@message</p>
    }
}

@code {
    [Parameter] public int id { get; set; }  // The {id} part from the URL

    private PostDto? post;  
    private List<CommentDto>? comments; 
    private List<UserDto>? users; 
    private CreateCommentDto newComment = new();  // Holds the new comment being created
    private string message = "";

    protected override async Task OnInitializedAsync()
    {
        post = await PostService.GetPostAsync(id);  // Fetch post details from the API
        users = await UserService.GetUsersAsync();
        var allComments = await CommentService.GetCommentsAsync();
        comments = allComments.Where(c => c.PostId == id).ToList();
    }
    
    private string GetAuthorName(int userId)
    {
        // Find the user by ID and return their username
        var user = users?.FirstOrDefault(u => u.Id == userId);
        return user != null ? user.Username : "Unknown";
    }
    
    private async Task AddCommentAsync()
    {
        if (string.IsNullOrWhiteSpace(newComment.Body))
        {
            message = "Comment cannot be empty.";
            return;
        }

        if (newComment.UserId == null || newComment.UserId <= 0)
        {
            message = "Invalid User ID.";
            return;
        }

        try
        {
            newComment.PostId = id;
            await CommentService.AddCommentAsync(newComment);
            message = "Comment added successfully!";

            // Refresh the comments list
            var allComments = await CommentService.GetCommentsAsync();
            comments = allComments.Where(c => c.PostId == id).ToList();

            // Reset the comment text field
            newComment.Body = "";
            
            StateHasChanged();
        }
        catch (Exception e)
        {
            message = $"Error adding comment: {e.Message}";
        }
    }
}